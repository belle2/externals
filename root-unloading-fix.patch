From 4ba5c1229aa875e4f88816b94d1c3fdc80301125 Mon Sep 17 00:00:00 2001
From: Thomas Hauth <Thomas.Hauth@kit.edu>
Date: Mon, 9 Nov 2015 17:44:18 +0100
Subject: [PATCH 1/3] added unloading check for ROOT

---
 core/base/src/TROOT.cxx  |  2 ++
 core/meta/src/TCling.cxx | 13 +++++++++++++
 2 files changed, 15 insertions(+)

diff --git a/core/base/src/TROOT.cxx b/core/base/src/TROOT.cxx
index 612e27c..f9c1109 100644
--- a/core/base/src/TROOT.cxx
+++ b/core/base/src/TROOT.cxx
@@ -263,6 +263,8 @@ Bool_t TROOT::fgMemCheck = kFALSE;
 
 static void at_exit_of_TROOT() {
    gROOT->~TROOT();
+   if (ROOT::gROOTLocal)
+      ROOT::gROOTLocal->~TROOT();
 }
 
 // This local static object initializes the ROOT system
diff --git a/core/meta/src/TCling.cxx b/core/meta/src/TCling.cxx
index d0331a7..d52d741 100644
--- a/core/meta/src/TCling.cxx
+++ b/core/meta/src/TCling.cxx
@@ -176,6 +176,19 @@ extern "C" {
 #define R__DLLEXPORT __declspec(dllexport)
 #endif
 #endif
+// Infrastructure to detect and react to libCling being teared down.
+//
+namespace {
+   class TCling_UnloadMarker {
+   public:
+      ~TCling_UnloadMarker() {
+         if (ROOT::gROOTLocal) {
+            ROOT::gROOTLocal->~TROOT();
+         }
+      }
+   };
+   static TCling_UnloadMarker gTClingUnloadMarker;
+}
 
 //______________________________________________________________________________
 // These functions are helpers for debugging issues with non-LLVMDEV builds.
-- 
1.9.1


From 82447da33b29f650e7b43425af51f8ad7a2d02c6 Mon Sep 17 00:00:00 2001
From: Philippe Canal <pcanal@fnal.gov>
Date: Thu, 5 Nov 2015 14:23:42 -0600
Subject: [PATCH 2/3] In CloseFiles, also delete the object held in TROOT's
 TDirectory part

---
 core/base/src/TROOT.cxx | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/core/base/src/TROOT.cxx b/core/base/src/TROOT.cxx
index f9c1109..6188e01 100644
--- a/core/base/src/TROOT.cxx
+++ b/core/base/src/TROOT.cxx
@@ -839,6 +839,9 @@ void TROOT::CloseFiles()
    if (fFiles && fFiles->First()) {
       R__ListSlowClose(static_cast<TList*>(fFiles));
    }
+   // and Close TROOT itself.
+   Close();
+   // Now sockets.
    if (fSockets && fSockets->First()) {
       if (0==fCleanups->FindObject(fSockets) ) {
          fCleanups->Add(fSockets);
-- 
1.9.1


From fbddb6d92df3fa43ba5d71cf773c1b347dca16c6 Mon Sep 17 00:00:00 2001
From: Thomas Hauth <Thomas.Hauth@kit.edu>
Date: Mon, 9 Nov 2015 19:35:43 +0100
Subject: [PATCH 3/3] removed constructor

---
 core/base/src/TROOT.cxx | 1 -
 1 file changed, 1 deletion(-)

diff --git a/core/base/src/TROOT.cxx b/core/base/src/TROOT.cxx
index 6188e01..c958fde 100644
--- a/core/base/src/TROOT.cxx
+++ b/core/base/src/TROOT.cxx
@@ -262,7 +262,6 @@ Bool_t TROOT::fgRootInit = kFALSE;
 Bool_t TROOT::fgMemCheck = kFALSE;
 
 static void at_exit_of_TROOT() {
-   gROOT->~TROOT();
    if (ROOT::gROOTLocal)
       ROOT::gROOTLocal->~TROOT();
 }
-- 
1.9.1

